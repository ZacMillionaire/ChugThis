<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.41.0/mapbox-gl.css' rel='stylesheet' />
<link href="~/css/site/mapbox.css" rel="stylesheet" />
<div id="mapbox-container" style='height: 80%;'>
    Loading...
</div>
<div id="info"></div>
@section Scripts {
    <script type="text/javascript">
        if ("geolocation" in navigator) {


            var _MapBox,
                _UserLocation, // [long, lat]
                _MapLoaded = false;

            function RenderMapBox(initialPosition) {
                document.getElementById("mapbox-container").innerHTML = "";
                console.log("Loading...")

                console.log(initialPosition.coords);
                _UserLocation = [initialPosition.coords.longitude, initialPosition.coords.latitude];

                mapboxgl.accessToken = "@ViewData["MapBoxKey"]";
                _MapBox = new mapboxgl.Map({
                    container: 'mapbox-container', // container id
                    style: 'mapbox://styles/mapbox/light-v9',
                    center: _UserLocation, // starting position
                    zoom: 16 // starting zoom
                });

                /*
                map.addControl(new mapboxgl.GeolocateControl({
                    positionOptions: {
                        enableHighAccuracy: true
                    },
                    trackUserLocation: true
                }));
                */
                _MapBox.on("load", function () {
                    console.log("loaded");
                    _MapBox.addSource("fuckwits", {
                        "type": "geojson",
                        "data": {
                            "type": "FeatureCollection",
                            "features": [
                                {
                                    "type": "Feature",
                                    "properties": {},
                                    "geometry": {
                                        "type": "Point",
                                        "coordinates": [
                                            153.00760368874035,
                                            -27.4677551075602,
                                        ]
                                    }
                                },
                                {
                                    "type": "Feature",
                                    "properties": {},
                                    "geometry": {
                                        "type": "Point",
                                        "coordinates": [
                                            153.00777106795368,
                                            -27.4677551075602,
                                        ]
                                    }
                                },
                                {
                                    "type": "Feature",
                                    "properties": {},
                                    "geometry": {
                                        "type": "Point",
                                        "coordinates": [
                                            153.00760368874035,
                                            -27.46780222416966,
                                        ]
                                    }
                                }
                            ]
                        },
                        cluster: true,
                        clusterMaxZoom: 20, // Max zoom to cluster points on
                        clusterRadius: 25, // Radius of each cluster when clustering points (defaults to 50)
                    });

                    _MapBox.addLayer({
                        id: "clusters",
                        type: "circle",
                        source: "fuckwits",
                        filter: ["has", "point_count"],
                        paint: {
                            "circle-color": {
                                property: "point_count",
                                type: "interval",
                                stops: [
                                    [0, "#51bbd6"],
                                    [100, "#f1f075"],
                                    [750, "#f28cb1"],
                                ]
                            },
                            "circle-radius": {
                                property: "point_count",
                                type: "interval",
                                stops: [
                                    [0, 20],
                                    [100, 30],
                                    [750, 40]
                                ]
                            }
                        }
                    });

                    _MapBox.addLayer({
                        id: "cluster-count",
                        type: "symbol",
                        source: "fuckwits",
                        filter: ["has", "point_count"],
                        layout: {
                            "text-field": "{point_count_abbreviated}",
                            "text-font": ["DIN Offc Pro Medium", "Arial Unicode MS Bold"],
                            "text-size": 12
                        }
                    });

                    _MapBox.addLayer({
                        "id": "symbols",
                        "type": "symbol",
                        "source": "fuckwits",
                        filter: ["!has", "point_count"],
                        "layout": {
                            "icon-image": "marker-15",
                            "icon-size":1
                        }
                    });

                    // User Location Tracking (geospatially, not analytics)
                    AddUserLocation(_MapBox);


                    _MapLoaded = true;

                });

                // auto zoom for clusters
                _MapBox.on('click', 'clusters', function (e) {
                    alert("click");
                    _MapBox.flyTo({ center: e.features[0].geometry.coordinates, zoom: 20 });
                });

                _MapBox.on('touchend', 'clusters', function (e) {
                    alert("touch");
                    _MapBox.flyTo({ center: e.features[0].geometry.coordinates, zoom: 20 });
                });

                // Change the cursor to a pointer when the it enters a feature in the 'symbols' layer.
                _MapBox.on('mouseenter', 'clusters', function () {
                    _MapBox.getCanvas().style.cursor = 'pointer';
                });

                // Change it back to a pointer when it leaves.
                _MapBox.on('mouseleave', 'clusters', function () {
                    _MapBox.getCanvas().style.cursor = '';
                });

                /*
                var updateLoc = debounce(function (a, b, c, d) {
                    UpdateLocDebug(a,b,c,d);
                }, 50);
                */
                _MapBox.on('mousemove', function (e) {
                    //updateLoc(e.point, e.lngLat, _MapBox.getZoom(), e.position);
                    UpdateLocDebug(e.point, e.lngLat, _MapBox.getZoom(), e.position);
                });
            }

            /*
            // conflicts with watchLocation. Basically this will be ignored if you use navigator.geolocation.getCurrentPosition in the same scope.
            // Neat.
            navigator.geolocation.getCurrentPosition(function (position) {
                console.log("adsf");
                RenderMapBox(position);
            }, function (err) {
                console.log("fucking garbage", err)
            });
            */

            function debounce(func, wait, immediate) {
                var timeout;
                return function () {
                    var context = this, args = arguments;
                    var later = function () {
                        timeout = null;
                        if (!immediate) func.apply(context, args);
                    };
                    var callNow = immediate && !timeout;
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                    if (callNow) func.apply(context, args);
                };
            };

            //var debouncedUpdate = debounce(function (NewLocation) {
            //    if (_MapLoaded) {
            //        var previousLocation = _UserLocation;
            //        _UserLocation = [NewLocation.coords.longitude, NewLocation.coords.latitude];
            //        UpdateUserLocation(_MapBox, previousLocation, _UserLocation);
            //    }
            //}, 0,true);

            navigator.geolocation.watchPosition(
                function (NewLocation) {
                    if (_MapLoaded) {
                        var previousLocation = _UserLocation;
                        _UserLocation = [NewLocation.coords.longitude, NewLocation.coords.latitude];
                        // Weird double call prevention, it's probably a Chome devtools thing, but who knows with JavaScript
                        if (JSON.stringify(previousLocation) !== JSON.stringify(_UserLocation)) {
                            UpdateUserLocation(_MapBox, previousLocation, _UserLocation);
                        }
                    } else {
                        RenderMapBox(NewLocation);
                    }
                }
            );

            function UpdateUserLocation(Map, OriginalLocation, NewLocation) {
                console.log("old",OriginalLocation,"new", NewLocation);
                Map.getSource("UserLocation")
                    .setData(CurrentUserLocation());

            }

            function CurrentUserLocation() {
                return {
                    type: "Point",
                    coordinates: _UserLocation
                };
            }

            function AddUserLocation(Map) {

                Map.addSource('UserLocation', {
                    "type": "geojson",
                    "data": CurrentUserLocation()
                });

                Map.addLayer({
                    id: "user",
                    type: "circle",
                    source: "UserLocation",
                    paint: {
                        "circle-radius": 10,
                        "circle-color": "#f0f"
                    }
                });
            }

            function UpdateLocDebug(point, lngLat, zoom, userloc) {
                document.getElementById('info').innerHTML =
                    // e.point is the x, y coordinates of the mousemove event relative
                    // to the top-left corner of the map
                    JSON.stringify(point) + '<br />' +
                    // e.lngLat is the longitude, latitude geographical position of the event
                JSON.stringify(lngLat) + "<br />" + JSON.stringify(_UserLocation);
            }
        } else {
            alert("can't locate");
            /* geolocation IS NOT available */
        }
        /*
        */
    </script>
}
